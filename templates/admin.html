<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Monitor — Admin</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root, [data-theme="dark"] {
            --bg-body:#0d1117; --bg-card:#161b22; --bg-inner:#0d1117; --bg-hover:#1c2128;
            --border:#30363d; --text-primary:#e6edf3; --text-secondary:#8b949e; --text-muted:#484f58;
            --green:#3fb950; --yellow:#d29922; --red:#f85149; --blue:#58a6ff; --purple:#bc8cff; --orange:#f0883e;
            --shadow:rgba(0,0,0,0.3);
        }
        [data-theme="light"] {
            --bg-body:#f0f2f5; --bg-card:#fff; --bg-inner:#f6f8fa; --bg-hover:#eef1f5;
            --border:#d0d7de; --text-primary:#1f2328; --text-secondary:#656d76; --text-muted:#8b949e;
            --green:#1a7f37; --yellow:#9a6700; --red:#cf222e; --blue:#0969da; --purple:#8250df; --orange:#bc4c00;
            --shadow:rgba(0,0,0,0.08);
        }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg-body); color:var(--text-primary); min-height:100vh; transition:background .3s; }

        /* Navbar */
        .navbar { background:var(--bg-card); border-bottom:1px solid var(--border); padding:0 24px; height:56px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 1px 3px var(--shadow); }
        .nav-left { display:flex; align-items:center; gap:12px; }
        .nav-left a { color:var(--text-secondary); text-decoration:none; font-size:14px; }
        .nav-left a:hover { color:var(--text-primary); }
        .nav-title { font-size:18px; font-weight:600; }
        .nav-right { display:flex; gap:12px; align-items:center; }
        .btn { padding:7px 16px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:transparent; color:var(--text-secondary); transition:all .2s; text-decoration:none; }
        .btn:hover { color:var(--text-primary); border-color:var(--text-secondary); }
        .btn-primary { background:var(--green); color:#fff; border-color:var(--green); }
        .btn-primary:hover { opacity:.85; }
        .btn-danger { color:var(--red); }
        .btn-danger:hover { background:rgba(248,81,73,.1); }
        .btn-sm { padding:4px 10px; font-size:12px; }
        .theme-toggle { font-size:16px; padding:4px 10px; }

        /* Main */
        .main { max-width:1200px; margin:0 auto; padding:24px; }

        /* Tabs */
        .tabs { display:flex; gap:4px; margin-bottom:20px; border-bottom:1px solid var(--border); }
        .tab { padding:10px 20px; font-size:14px; font-weight:500; color:var(--text-secondary); cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; background:none; border-top:none; border-left:none; border-right:none; }
        .tab.active { color:var(--text-primary); border-bottom-color:var(--blue); }
        .tab:hover { color:var(--text-primary); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        /* Table */
        .table-wrap { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; font-size:13px; }
        th { text-align:left; padding:10px 12px; color:var(--text-secondary); font-weight:600; text-transform:uppercase; font-size:11px; letter-spacing:.5px; border-bottom:1px solid var(--border); }
        td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle; }
        tr:hover td { background:var(--bg-hover); }
        .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; }
        .badge-admin { background:rgba(188,140,255,.15); color:var(--purple); }
        .badge-user { background:rgba(88,166,255,.12); color:var(--blue); }
        .badge-yes { background:rgba(63,185,80,.15); color:var(--green); }
        .badge-no { background:rgba(139,148,158,.15); color:var(--text-muted); }
        .badge-used { background:rgba(139,148,158,.15); color:var(--text-muted); }
        .badge-active { background:rgba(63,185,80,.15); color:var(--green); }
        .badge-expired { background:rgba(248,81,73,.15); color:var(--red); }
        .server-tags { display:flex; flex-wrap:wrap; gap:4px; }
        .server-tag { background:var(--bg-inner); border:1px solid var(--border); padding:1px 6px; border-radius:4px; font-size:11px; color:var(--text-secondary); }
        td.actions { white-space: nowrap; }
        td.actions .btn { margin-right: 6px; }
        td.actions .btn:last-child { margin-right: 0; }
        .invite-url { font-size:11px; color:var(--blue); word-break:break-all; max-width:280px; cursor:pointer; }
        .invite-url:hover { text-decoration:underline; }
        .empty-row { text-align:center; padding:40px; color:var(--text-muted); font-size:14px; }

        /* Modal */
        .modal-overlay { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,.55); z-index:200; align-items:center; justify-content:center; }
        .modal-overlay.active { display:flex; }
        .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:28px; max-width:520px; width:92%; max-height:85vh; overflow-y:auto; }
        .modal h3 { font-size:17px; margin-bottom:18px; }
        .form-group { margin-bottom:14px; }
        .form-group label { display:block; font-size:13px; font-weight:500; color:var(--text-secondary); margin-bottom:5px; }
        .form-group input, .form-group select { width:100%; padding:9px 12px; font-size:14px; color:var(--text-primary); background:var(--bg-inner); border:1px solid var(--border); border-radius:6px; outline:none; }
        .form-group input:focus, .form-group select:focus { border-color:var(--blue); }
        .form-row { display:flex; gap:12px; }
        .form-row .form-group { flex:1; }
        .checkbox-group { display:flex; align-items:center; gap:8px; }
        .checkbox-group input[type=checkbox] { width:auto; }
        .server-select { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .server-chip { padding:4px 10px; border-radius:6px; font-size:12px; cursor:pointer; border:1px solid var(--border); background:var(--bg-inner); color:var(--text-secondary); transition:all .15s; }
        .server-chip.selected { background:var(--blue); color:#fff; border-color:var(--blue); }
        .gpu-access-wrap { margin-top:8px; display:flex; flex-direction:column; gap:8px; }
        .gpu-access-group { border:1px solid var(--border); border-radius:8px; padding:8px; background:var(--bg-inner); }
        .gpu-access-title { font-size:12px; color:var(--text-secondary); margin-bottom:6px; }
        .gpu-chip { display:inline-flex; margin:2px 4px 2px 0; padding:3px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); color:var(--text-secondary); cursor:pointer; }
        .gpu-chip.selected { background:var(--orange); color:#fff; border-color:var(--orange); }
        .gpu-hint { font-size:11px; color:var(--text-muted); margin-top:4px; }
        .gpu-row { border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:8px; background:var(--bg-inner); }
        .gpu-row-top { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px; }
        .gpu-row-name { font-size:12px; color:var(--text-primary); font-weight:600; }
        .gpu-row-meta { font-size:11px; color:var(--text-secondary); }
        .gpu-row-controls { display:flex; gap:8px; align-items:center; }
        .gpu-row-controls select, .gpu-row-controls input { font-size:12px; padding:6px 8px; }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
        .result-box { background:var(--bg-inner); border:1px solid var(--border); border-radius:8px; padding:14px; margin-top:14px; }
        .result-box .label { font-size:12px; color:var(--text-muted); margin-bottom:4px; }
        .result-box .value { font-size:15px; font-weight:600; font-family:monospace; color:var(--orange); word-break:break-all; user-select:all; }
        .copy-btn { font-size:12px; color:var(--blue); cursor:pointer; margin-left:8px; }
        .copy-btn:hover { text-decoration:underline; }
        .hostname-sub { font-size:12px; color:var(--text-secondary); margin-top:3px; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="/">&larr; Dashboard</a>
        <span class="nav-title">Admin Panel</span>
    </div>
    <div class="nav-right">
        <button class="btn theme-toggle" id="themeToggle">&#x2600;</button>
        <a href="/logout" class="btn">Logout</a>
    </div>
</nav>

<main class="main">
    <div class="tabs">
        <button class="tab active" data-tab="users">Users</button>
        <button class="tab" data-tab="invites">Invites</button>
        <button class="tab" data-tab="servers">Servers</button>
        <button class="tab" data-tab="announcements">Announcements</button>
        <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- Users Tab -->
    <div class="tab-content active" id="tab-users">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <span style="font-size:14px;color:var(--text-secondary)" id="userCountLabel"></span>
            <button class="btn btn-primary" onclick="openCreateUser()">+ Create User</button>
        </div>
        <div class="table-wrap">
            <table><thead><tr>
                <th>Username</th><th>Role</th><th>View Processes</th><th>Server Access</th><th>Created</th><th>Actions</th>
            </tr></thead><tbody id="usersBody"></tbody></table>
        </div>
    </div>

    <!-- Invites Tab -->
    <div class="tab-content" id="tab-invites">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <span style="font-size:14px;color:var(--text-secondary)" id="inviteCountLabel"></span>
            <button class="btn btn-primary" onclick="openCreateInvite()">+ Create Invite</button>
        </div>
        <div class="table-wrap">
            <table><thead><tr>
                <th>Invite Link</th><th>Role</th><th>Procs</th><th>Servers</th><th>Uses</th><th>Expires</th><th>Status</th><th>Actions</th>
            </tr></thead><tbody id="invitesBody"></tbody></table>
        </div>
    </div>

    <!-- Servers Tab -->
    <div class="tab-content" id="tab-servers">
        <div style="margin-bottom:16px;">
            <span style="font-size:14px;color:var(--text-secondary)" id="serverCountLabel"></span>
        </div>
        <div class="table-wrap">
            <table><thead><tr>
                <th>Display Name</th><th>Identity</th><th>IP</th><th>Status</th><th>Note</th><th>Actions</th>
            </tr></thead><tbody id="serversBody"></tbody></table>
        </div>
    </div>

    <!-- Announcements Tab -->
    <div class="tab-content" id="tab-announcements">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <span style="font-size:14px;color:var(--text-secondary)" id="annCountLabel"></span>
            <button class="btn btn-primary" onclick="openCreateAnn()">+ New Announcement</button>
        </div>
        <div class="table-wrap">
            <table><thead><tr>
                <th>Content</th><th>Level</th><th>Active</th><th>Created</th><th>Actions</th>
            </tr></thead><tbody id="annBody"></tbody></table>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="tab-settings">
        <div class="modal" style="max-width:680px;width:100%;padding:22px;">
            <h3 style="margin-bottom:14px;">Registration Email Policy</h3>
            <div class="checkbox-group" style="margin-bottom:12px;">
                <input type="checkbox" id="regEmailSuffixEnabled">
                <label for="regEmailSuffixEnabled" style="margin:0;color:var(--text-secondary);font-size:14px;">
                    Only accept specific email suffixes during registration
                </label>
            </div>
            <div class="form-group">
                <label>Allowed suffixes (comma separated)</label>
                <input type="text" id="regEmailSuffixes" placeholder="@company.com, @lab.org">
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:-6px;margin-bottom:14px;">
                Example: <code>@company.com,@school.edu</code>
            </div>
            <div class="modal-actions" style="justify-content:flex-start;margin-top:0;">
                <button class="btn btn-primary" onclick="saveRegistrationSettings()">Save Settings</button>
                <span id="settingsMsg" style="font-size:12px;color:var(--text-secondary);"></span>
            </div>
        </div>
    </div>
</main>

<!-- Server Status Modal -->
<div class="modal-overlay" id="serverStatusModal">
    <div class="modal">
        <h3>Set Server Status</h3>
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px" id="ssHostname"></p>
        <div class="form-group">
            <label>Status</label>
            <select id="ssStatus">
                <option value="normal">Normal</option>
                <option value="maintenance">Maintenance</option>
                <option value="fault">Faulty</option>
            </select>
        </div>
        <div class="form-group">
            <label>Note (optional)</label>
            <input type="text" id="ssNote" placeholder="e.g. Replacing GPU 3, ETA 2 days">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('serverStatusModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitServerStatus()">Save</button>
        </div>
    </div>
</div>

<!-- Server Name Modal -->
<div class="modal-overlay" id="serverNameModal">
    <div class="modal">
        <h3>Set Server Display Name</h3>
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px" id="snHostname"></p>
        <div class="form-group">
            <label>Display Name (global for all users)</label>
            <input type="text" id="snDisplayName" placeholder="Leave empty to use system hostname">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('serverNameModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitServerName()">Save</button>
        </div>
    </div>
</div>

<!-- GPU Status Modal -->
<div class="modal-overlay" id="gpuStatusModal">
    <div class="modal" style="max-width:720px;">
        <h3>GPU Status Management</h3>
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px" id="gsHostname"></p>
        <div id="gsGpuList"></div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('gpuStatusModal')">Close</button>
        </div>
    </div>
</div>

<!-- Announcement Modal -->
<div class="modal-overlay" id="annModal">
    <div class="modal">
        <h3 id="annModalTitle">New Announcement</h3>
        <div class="form-group">
            <label>Content</label>
            <input type="text" id="annContent" placeholder="Announcement message...">
        </div>
        <div class="form-group">
            <label>Level</label>
            <select id="annLevel">
                <option value="info">Info (blue)</option>
                <option value="warning">Warning (yellow)</option>
                <option value="critical">Critical (red)</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('annModal')">Cancel</button>
            <button class="btn btn-primary" id="annModalBtn" onclick="submitAnn()">Create</button>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal-overlay" id="userModal">
    <div class="modal">
        <h3 id="userModalTitle">Create User</h3>
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="umUsername" placeholder="username">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="umEmail" placeholder="user@example.com">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Role</label>
                <select id="umRole"><option value="user">User</option><option value="admin">Admin</option></select>
            </div>
            <div class="form-group">
                <label>View Processes</label>
                <select id="umProcs"><option value="0">No</option><option value="1">Yes</option></select>
            </div>
        </div>
        <div class="form-group">
            <label>Server Access</label>
            <div class="server-select" id="umServers"></div>
            <div class="gpu-hint">For each selected server: no GPU selected means all GPUs are visible.</div>
            <div class="gpu-access-wrap" id="umGpuAccess"></div>
        </div>
        <div id="userResult"></div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('userModal')">Cancel</button>
            <button class="btn btn-primary" id="userModalBtn" onclick="submitUser()">Create</button>
        </div>
    </div>
</div>

<!-- Create Invite Modal -->
<div class="modal-overlay" id="inviteModal">
    <div class="modal">
        <h3>Create Invite Link</h3>
        <div class="form-row">
            <div class="form-group">
                <label>Role</label>
                <select id="imRole"><option value="user">User</option><option value="admin">Admin</option></select>
            </div>
            <div class="form-group">
                <label>View Processes</label>
                <select id="imProcs"><option value="0">No</option><option value="1">Yes</option></select>
            </div>
        </div>
        <div class="form-group">
            <label>Expires in (hours)</label>
            <input type="number" id="imExpiry" value="72" min="1" max="8760">
        </div>
        <div class="form-group">
            <label>Max users / 最大人数</label>
            <input type="number" id="imMaxUses" value="1" min="1" max="10000">
        </div>
        <div class="form-group">
            <label>Server Access</label>
            <div class="server-select" id="imServers"></div>
        </div>
        <div id="inviteResult"></div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('inviteModal')">Cancel</button>
            <button class="btn btn-primary" id="inviteModalBtn" onclick="submitInvite()">Create</button>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" id="resetModal">
    <div class="modal">
        <h3>Reset Password</h3>
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px">
            Set a new password for <strong id="resetUserName"></strong> (leave blank to auto-generate).
        </p>
        <div class="form-group">
            <label>New Password (Optional) / 新密码（可选）</label>
            <input type="password" id="resetCustomPw" placeholder="At least 6 characters; blank = random">
        </div>
        <div id="resetResult"></div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('resetModal')">Close</button>
            <button class="btn btn-primary" id="resetBtn" onclick="confirmReset()">Reset</button>
        </div>
    </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let allServers = [];
let editingUserId = null;
let resetUserId = null;
let namingServerId = null;
let editingUserGpuAccess = {};
let gpuStatusServerId = null;
let gpuStatusRows = [];

// ---------------------------------------------------------------------------
// Theme
// ---------------------------------------------------------------------------
(function(){
    const s = localStorage.getItem('sm-theme')||'dark';
    document.documentElement.setAttribute('data-theme', s);
    const btn = document.getElementById('themeToggle');
    btn.innerHTML = s==='dark'?'&#x2600;':'&#x1F319;';
    btn.onclick = ()=>{
        const c = document.documentElement.getAttribute('data-theme');
        const n = c==='dark'?'light':'dark';
        document.documentElement.setAttribute('data-theme', n);
        localStorage.setItem('sm-theme', n);
        btn.innerHTML = n==='dark'?'&#x2600;':'&#x1F319;';
    };
})();

// ---------------------------------------------------------------------------
// Tabs
// ---------------------------------------------------------------------------
document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    });
});

// ---------------------------------------------------------------------------
// API helpers
// ---------------------------------------------------------------------------
function api(url, opts={}) {
    return fetch(url, { headers: {'Content-Type':'application/json'}, ...opts })
        .then(r => { if(r.status===401) window.location='/login'; return r.json(); });
}

function fmtTime(ts) {
    if(!ts) return '-';
    return new Date(ts).toLocaleString('zh-CN',{hour12:false});
}

function copyText(text) {
    if (!text) return;
    const fallbackCopy = () => {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        let ok = false;
        try { ok = document.execCommand('copy'); } catch (_) { ok = false; }
        document.body.removeChild(ta);
        if (!ok) {
            window.prompt('Copy manually / 请手动复制:', text);
        }
    };

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}

// ---------------------------------------------------------------------------
// Load data
// ---------------------------------------------------------------------------
function loadUsers() {
    api('/api/admin/users').then(users => {
        document.getElementById('userCountLabel').textContent = users.length + ' user(s)';
        const tb = document.getElementById('usersBody');
        if(users.length===0) { tb.innerHTML='<tr><td colspan="6" class="empty-row">No users</td></tr>'; return; }
        tb.innerHTML = users.map(u => {
            const roleBadge = u.role==='admin' ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-user">User</span>';
            const procsBadge = u.can_view_processes ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>';
            let serverHTML = '';
            if(u.role==='admin') {
                serverHTML = '<span class="badge badge-admin">All</span>';
            } else if(u.server_ids.length===0) {
                serverHTML = '<span style="color:var(--text-muted);font-size:12px">None</span>';
            } else {
                const names = u.server_ids.map(sid => { const s=allServers.find(x=>x.id===sid); return s?s.hostname:'#'+sid; });
                serverHTML = '<div class="server-tags">'+names.map(n=>'<span class="server-tag">'+n+'</span>').join('')+'</div>';
            }
            const gpuRestrictCount = Object.keys(u.gpu_access || {}).length;
            if (gpuRestrictCount > 0) {
                serverHTML += `<div style="font-size:11px;color:var(--orange);margin-top:4px;">GPU-limited on ${gpuRestrictCount} server(s)</div>`;
            }
            const userLabel = `<div><strong>${u.username}</strong></div><div style="font-size:12px;color:var(--text-secondary)">${u.email || '-'}</div>`;
            return `<tr>
                <td>${userLabel}</td>
                <td>${roleBadge}</td>
                <td>${procsBadge}</td>
                <td>${serverHTML}</td>
                <td style="font-size:12px;color:var(--text-muted)">${fmtTime(u.created_at)}</td>
                <td class="actions">
                    <button class="btn btn-sm" onclick="openEditUser(${u.id})">Edit</button>
                    <button class="btn btn-sm" onclick="openResetPw(${u.id},'${u.username}')">Reset PW</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id},'${u.username}')">Delete</button>
                </td>
            </tr>`;
        }).join('');
    });
}

function loadInvites() {
    api('/api/admin/invites').then(invites => {
        document.getElementById('inviteCountLabel').textContent = invites.length + ' invite(s)';
        const tb = document.getElementById('invitesBody');
        if(invites.length===0) { tb.innerHTML='<tr><td colspan="8" class="empty-row">No invites</td></tr>'; return; }
        tb.innerHTML = invites.map(inv => {
            const url = location.origin+'/register?token='+inv.token;
            const roleBadge = inv.role==='admin'?'<span class="badge badge-admin">Admin</span>':'<span class="badge badge-user">User</span>';
            const procsBadge = inv.can_view_processes?'Yes':'No';
            const srvNames = (inv.server_ids||[]).map(sid=>{const s=allServers.find(x=>x.id===sid);return s?s.hostname:'#'+sid;}).join(', ')||'None';
            const uses = `${inv.used_count || 0}/${inv.max_uses || 1}`;
            let statusBadge;
            if(inv.expires_at && new Date(inv.expires_at)<new Date()) statusBadge = '<span class="badge badge-expired">Expired</span>';
            else if((inv.used_count || 0) >= (inv.max_uses || 1)) statusBadge = '<span class="badge badge-used">Full</span>';
            else statusBadge = '<span class="badge badge-active">Active</span>';
            return `<tr>
                <td><span class="invite-url" onclick="copyText('${url}')" title="Click to copy">${url}</span></td>
                <td>${roleBadge}</td>
                <td>${procsBadge}</td>
                <td style="font-size:12px">${srvNames}</td>
                <td style="font-size:12px">${uses}</td>
                <td style="font-size:12px;color:var(--text-muted)">${fmtTime(inv.expires_at)}</td>
                <td>${statusBadge}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteInvite(${inv.id})">Revoke</button></td>
            </tr>`;
        }).join('');
    });
}

// ---------------------------------------------------------------------------
// Server chip selector
// ---------------------------------------------------------------------------
function renderServerChips(containerId, selected=[]) {
    const el = document.getElementById(containerId);
    el.innerHTML = allServers.map(s => {
        const sel = selected.includes(s.id) ? 'selected' : '';
        return `<span class="server-chip ${sel}" data-sid="${s.id}" onclick="toggleChip(this)">${s.hostname}</span>`;
    }).join('') || '<span style="color:var(--text-muted);font-size:12px">No servers registered yet</span>';
    if (containerId === 'umServers') {
        renderGpuAccessEditor();
    }
}

function toggleChip(el) {
    if (el.parentElement && el.parentElement.id === 'umServers') {
        snapshotGpuAccessEditor();
    }
    el.classList.toggle('selected');
    if (el.parentElement && el.parentElement.id === 'umServers') {
        renderGpuAccessEditor();
    }
}

function getSelectedServerIds(containerId) {
    return [...document.querySelectorAll('#'+containerId+' .server-chip.selected')].map(c=>parseInt(c.dataset.sid));
}

function getGpuAccessFromEditor(selectedServerIds) {
    const result = {};
    selectedServerIds.forEach(sid => {
        const box = document.querySelector(`.gpu-access-group[data-sid="${sid}"]`);
        if (!box) return;
        const allChips = [...box.querySelectorAll('.gpu-chip')];
        const selected = allChips.filter(ch => ch.classList.contains('selected')).map(ch => ch.dataset.busId);
        // none selected or all selected => no restriction (all visible)
        if (selected.length === 0 || selected.length === allChips.length) return;
        result[String(sid)] = selected;
    });
    return result;
}

function snapshotGpuAccessEditor() {
    const groups = [...document.querySelectorAll('#umGpuAccess .gpu-access-group')];
    const next = {};
    groups.forEach(g => {
        const sid = g.dataset.sid;
        const selected = [...g.querySelectorAll('.gpu-chip.selected')].map(ch => ch.dataset.busId);
        if (selected.length > 0) next[sid] = selected;
    });
    editingUserGpuAccess = next;
}

function renderGpuAccessEditor() {
    const wrap = document.getElementById('umGpuAccess');
    const selectedServerIds = getSelectedServerIds('umServers');
    if (selectedServerIds.length === 0) {
        wrap.innerHTML = '';
        return;
    }
    wrap.innerHTML = selectedServerIds.map(sid => {
        const srv = allServers.find(s => s.id === sid);
        if (!srv) return '';
        const gpus = srv.gpus || [];
        if (gpus.length === 0) {
            return `<div class="gpu-access-group" data-sid="${sid}">
                <div class="gpu-access-title">${srv.hostname}</div>
                <div class="gpu-hint">No GPU discovered yet on this server.</div>
            </div>`;
        }
        const selectedBus = new Set((editingUserGpuAccess[String(sid)] || []).map(x => String(x).toLowerCase()));
        const chips = gpus.map(g => {
            const bus = (g.bus_id || '').toLowerCase();
            const sel = selectedBus.has(bus) ? 'selected' : '';
            const label = `${g.name || 'GPU'} (${bus})`;
            return `<span class="gpu-chip ${sel}" data-bus-id="${bus}" onclick="this.classList.toggle('selected')">${label}</span>`;
        }).join('');
        return `<div class="gpu-access-group" data-sid="${sid}">
            <div class="gpu-access-title">${srv.hostname}</div>
            <div>${chips}</div>
            <div class="gpu-hint">Select specific GPUs to limit visibility.</div>
        </div>`;
    }).join('');
}

// ---------------------------------------------------------------------------
// Modals
// ---------------------------------------------------------------------------
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openCreateUser() {
    editingUserId = null;
    editingUserGpuAccess = {};
    document.getElementById('userModalTitle').textContent = 'Create User';
    document.getElementById('userModalBtn').textContent = 'Create';
    document.getElementById('userModalBtn').style.display = '';
    document.getElementById('umUsername').value = '';
    document.getElementById('umEmail').value = '';
    document.getElementById('umUsername').disabled = false;
    document.getElementById('umEmail').disabled = false;
    document.getElementById('umRole').value = 'user';
    document.getElementById('umProcs').value = '0';
    document.getElementById('userResult').innerHTML = '';
    renderServerChips('umServers', []);
    document.getElementById('userModal').classList.add('active');
}

function openEditUser(uid) {
    api('/api/admin/users').then(users => {
        const u = users.find(x=>x.id===uid);
        if(!u) return;
        editingUserId = uid;
        editingUserGpuAccess = u.gpu_access || {};
        document.getElementById('userModalTitle').textContent = 'Edit User: '+u.username;
        document.getElementById('userModalBtn').textContent = 'Save';
        document.getElementById('userModalBtn').style.display = '';
        document.getElementById('umUsername').value = u.username;
        document.getElementById('umEmail').value = u.email || '';
        document.getElementById('umUsername').disabled = true;
        document.getElementById('umEmail').disabled = true;
        document.getElementById('umRole').value = u.role;
        document.getElementById('umProcs').value = u.can_view_processes?'1':'0';
        document.getElementById('userResult').innerHTML = '';
        renderServerChips('umServers', u.server_ids);
        document.getElementById('userModal').classList.add('active');
    });
}

function submitUser() {
    const username = document.getElementById('umUsername').value.trim();
    const email = document.getElementById('umEmail').value.trim();
    const role = document.getElementById('umRole').value;
    const canView = document.getElementById('umProcs').value === '1';
    const serverIds = getSelectedServerIds('umServers');
    const gpuAccess = getGpuAccessFromEditor(serverIds);

    if(editingUserId) {
        api('/api/admin/users/'+editingUserId, {
            method:'PUT', body:JSON.stringify({role, can_view_processes:canView, server_ids:serverIds, gpu_access:gpuAccess})
        }).then(r => {
            if(r.error) { alert(r.error); return; }
            closeModal('userModal');
            loadUsers();
        });
    } else {
        if(!username) { alert('Username is required'); return; }
        if(!email) { alert('Email is required'); return; }
        api('/api/admin/users', {
            method:'POST', body:JSON.stringify({username, email, role, can_view_processes:canView, server_ids:serverIds, gpu_access:gpuAccess})
        }).then(r => {
            if(r.error) { alert(r.error); return; }
            document.getElementById('userResult').innerHTML = `
                <div class="result-box">
                    <div class="label">Generated Password (shown once) / 生成的密码（仅显示一次）</div>
                    <div class="value">${r.password} <span class="copy-btn" onclick="copyText('${r.password}')">Copy</span></div>
                </div>`;
            document.getElementById('userModalBtn').style.display = 'none';
            loadUsers();
        });
    }
}

function deleteUser(uid, name) {
    if(!confirm('Delete user "'+name+'"? This cannot be undone.')) return;
    api('/api/admin/users/'+uid, {method:'DELETE'}).then(r => {
        if(r.error) { alert(r.error); return; }
        loadUsers();
    });
}

// ---------------------------------------------------------------------------
// Reset Password
// ---------------------------------------------------------------------------
function openResetPw(uid, name) {
    resetUserId = uid;
    document.getElementById('resetUserName').textContent = name;
    document.getElementById('resetCustomPw').value = '';
    document.getElementById('resetResult').innerHTML = '';
    document.getElementById('resetBtn').style.display = '';
    document.getElementById('resetModal').classList.add('active');
}

function confirmReset() {
    const customPassword = document.getElementById('resetCustomPw').value.trim();
    if (customPassword && customPassword.length < 6) {
        alert('Password must be at least 6 characters / 密码至少 6 个字符');
        return;
    }
    api('/api/admin/users/'+resetUserId+'/reset-password', {
        method:'POST',
        body: JSON.stringify({password: customPassword})
    }).then(r => {
        if(r.error) { alert(r.error); return; }
        document.getElementById('resetResult').innerHTML = `
            <div class="result-box">
                <div class="label">New Password (shown once) / 新密码（仅显示一次）</div>
                <div class="value">${r.password} <span class="copy-btn" onclick="copyText('${r.password}')">Copy</span></div>
            </div>`;
        document.getElementById('resetBtn').style.display = 'none';
    });
}

// ---------------------------------------------------------------------------
// Invites
// ---------------------------------------------------------------------------
function openCreateInvite() {
    document.getElementById('imRole').value = 'user';
    document.getElementById('imProcs').value = '0';
    document.getElementById('imExpiry').value = '72';
    document.getElementById('imMaxUses').value = '1';
    document.getElementById('inviteResult').innerHTML = '';
    document.getElementById('inviteModalBtn').style.display = '';
    renderServerChips('imServers', []);
    document.getElementById('inviteModal').classList.add('active');
}

function submitInvite() {
    const role = document.getElementById('imRole').value;
    const canView = document.getElementById('imProcs').value === '1';
    const expiry = parseInt(document.getElementById('imExpiry').value) || 72;
    const maxUses = parseInt(document.getElementById('imMaxUses').value) || 1;
    const serverIds = getSelectedServerIds('imServers');

    api('/api/admin/invites', {
        method:'POST', body:JSON.stringify({role, can_view_processes:canView, expire_hours:expiry, max_uses:maxUses, server_ids:serverIds})
    }).then(r => {
        if(r.error) { alert(r.error); return; }
        document.getElementById('inviteResult').innerHTML = `
            <div class="result-box">
                <div class="label">Invite Link (click to copy) / 邀请链接（点击复制）</div>
                <div class="value" style="color:var(--blue);cursor:pointer" onclick="copyText('${r.url}')">${r.url}</div>
            </div>`;
        document.getElementById('inviteModalBtn').style.display = 'none';
        loadInvites();
    });
}

function deleteInvite(id) {
    if(!confirm('Revoke this invite?')) return;
    api('/api/admin/invites/'+id, {method:'DELETE'}).then(() => loadInvites());
}

function loadRegistrationSettings() {
    api('/api/admin/settings/registration').then(r => {
        if (r.error) return;
        document.getElementById('regEmailSuffixEnabled').checked = !!r.email_suffix_enabled;
        document.getElementById('regEmailSuffixes').value = (r.allowed_suffixes || []).join(', ');
    });
}

function saveRegistrationSettings() {
    const enabled = document.getElementById('regEmailSuffixEnabled').checked;
    const raw = document.getElementById('regEmailSuffixes').value.trim();
    api('/api/admin/settings/registration', {
        method:'PUT',
        body:JSON.stringify({email_suffix_enabled: enabled, allowed_suffixes_raw: raw})
    }).then(r => {
        const msg = document.getElementById('settingsMsg');
        if(r.error) {
            msg.style.color = 'var(--red)';
            msg.textContent = r.error;
            return;
        }
        msg.style.color = 'var(--green)';
        msg.textContent = 'Saved';
        document.getElementById('regEmailSuffixes').value = (r.allowed_suffixes || []).join(', ');
    });
}

// ---------------------------------------------------------------------------
// Modal click-outside-to-close
// ---------------------------------------------------------------------------
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if(e.target === m) closeModal(m.id); });
});

// ---------------------------------------------------------------------------
// Servers Tab
// ---------------------------------------------------------------------------
let statusServerId = null;

function loadServers() {
    api('/api/admin/servers').then(servers => {
        allServers = servers;
        document.getElementById('serverCountLabel').textContent = servers.length + ' server(s)';
        const tb = document.getElementById('serversBody');
        if(servers.length===0) { tb.innerHTML='<tr><td colspan="6" class="empty-row">No servers</td></tr>'; return; }
        tb.innerHTML = servers.map(s => {
            const st = s.admin_status || 'normal';
            let badge;
            if(st==='maintenance') badge='<span class="badge" style="background:rgba(210,153,34,.2);color:var(--yellow)">Maintenance</span>';
            else if(st==='fault') badge='<span class="badge" style="background:rgba(248,81,73,.2);color:var(--red)">Faulty</span>';
            else badge='<span class="badge badge-yes">Normal</span>';
            const nameHtml = `<div><strong>${s.hostname}</strong></div><div class="hostname-sub">system: ${s.raw_hostname}</div>`;
            const identity = s.mac_address || 'legacy(no-mac)';
            return `<tr>
                <td>${nameHtml}</td>
                <td style="font-size:12px">${identity}</td>
                <td style="font-size:12px">${s.ip||'-'}</td>
                <td>${badge}</td>
                <td style="font-size:12px;color:var(--text-muted);max-width:200px">${s.admin_status_note||'-'}</td>
                <td class="actions">
                    <button class="btn btn-sm" onclick="openServerName(${s.id},'${(s.raw_hostname||'').replace(/'/g,"\\'")}','${(s.display_name||'').replace(/'/g,"\\'")}')">Set Name</button>
                    <button class="btn btn-sm" onclick="openServerStatus(${s.id},'${(s.hostname||'').replace(/'/g,"\\'")}','${st}','${(s.admin_status_note||'').replace(/'/g,"\\'")}')">Set Status</button>
                    <button class="btn btn-sm" onclick="openGpuStatus(${s.id},'${(s.hostname||'').replace(/'/g,"\\'")}')">Manage GPUs</button>
                </td>
            </tr>`;
        }).join('');
    });
}

function openServerName(id, rawHostname, displayName) {
    namingServerId = id;
    document.getElementById('snHostname').textContent = 'System hostname: ' + rawHostname;
    document.getElementById('snDisplayName').value = displayName || '';
    document.getElementById('serverNameModal').classList.add('active');
}

function submitServerName() {
    const displayName = document.getElementById('snDisplayName').value.trim();
    api('/api/admin/servers/'+namingServerId+'/name', {
        method:'PUT', body:JSON.stringify({display_name: displayName})
    }).then(r => {
        if(r.error) { alert(r.error); return; }
        closeModal('serverNameModal');
        loadServers();
        loadUsers();
        loadInvites();
    });
}

function openServerStatus(id, hostname, status, note) {
    statusServerId = id;
    document.getElementById('ssHostname').textContent = hostname;
    document.getElementById('ssStatus').value = status;
    document.getElementById('ssNote').value = note;
    document.getElementById('serverStatusModal').classList.add('active');
}

function submitServerStatus() {
    const status = document.getElementById('ssStatus').value;
    const note = document.getElementById('ssNote').value;
    api('/api/admin/servers/'+statusServerId+'/status', {
        method:'PUT', body:JSON.stringify({admin_status:status, admin_status_note:note})
    }).then(r => {
        if(r.error) { alert(r.error); return; }
        closeModal('serverStatusModal');
        loadServers();
    });
}

function openGpuStatus(serverId, hostname) {
    gpuStatusServerId = serverId;
    document.getElementById('gsHostname').textContent = hostname;
    document.getElementById('gsGpuList').innerHTML = '<div class="gpu-hint">Loading...</div>';
    document.getElementById('gpuStatusModal').classList.add('active');
    api('/api/admin/servers/' + serverId + '/gpus').then(r => {
        if (r.error) {
            document.getElementById('gsGpuList').innerHTML = `<div class="gpu-hint" style="color:var(--red)">${r.error}</div>`;
            return;
        }
        gpuStatusRows = r.gpus || [];
        if (gpuStatusRows.length === 0) {
            document.getElementById('gsGpuList').innerHTML = '<div class="gpu-hint">No GPU discovered from latest metrics.</div>';
            return;
        }
        document.getElementById('gsGpuList').innerHTML = gpuStatusRows.map((g, idx) => {
            const st = g.admin_status || 'normal';
            const note = g.admin_status_note || '';
            return `<div class="gpu-row">
                <div class="gpu-row-top">
                    <div>
                        <div class="gpu-row-name">${g.name || 'GPU'} (index ${g.index ?? '-'})</div>
                        <div class="gpu-row-meta">bus_id: ${g.bus_id}</div>
                    </div>
                </div>
                <div class="gpu-row-controls">
                    <select id="gpuStatus_${idx}">
                        <option value="normal" ${st==='normal'?'selected':''}>Normal</option>
                        <option value="maintenance" ${st==='maintenance'?'selected':''}>Maintenance</option>
                        <option value="fault" ${st==='fault'?'selected':''}>Faulty</option>
                    </select>
                    <input id="gpuNote_${idx}" type="text" value="${note.replace(/"/g, '&quot;')}" placeholder="note (optional)">
                    <button class="btn btn-sm btn-primary" onclick="saveGpuStatus(${idx})">Save</button>
                </div>
            </div>`;
        }).join('');
    });
}

function saveGpuStatus(idx) {
    const g = gpuStatusRows[idx];
    if (!g) return;
    const status = document.getElementById('gpuStatus_' + idx).value;
    const note = document.getElementById('gpuNote_' + idx).value.trim();
    api('/api/admin/servers/' + gpuStatusServerId + '/gpus/status', {
        method: 'PUT',
        body: JSON.stringify({gpu_bus_id: g.bus_id, admin_status: status, admin_status_note: note})
    }).then(r => {
        if (r.error) { alert(r.error); return; }
        openGpuStatus(gpuStatusServerId, document.getElementById('gsHostname').textContent || '');
        loadServers();
    });
}

// ---------------------------------------------------------------------------
// Announcements Tab
// ---------------------------------------------------------------------------
let editingAnnId = null;

function loadAnnouncements() {
    api('/api/admin/announcements').then(anns => {
        document.getElementById('annCountLabel').textContent = anns.length + ' announcement(s)';
        const tb = document.getElementById('annBody');
        if(anns.length===0) { tb.innerHTML='<tr><td colspan="5" class="empty-row">No announcements</td></tr>'; return; }
        tb.innerHTML = anns.map(a => {
            let lvlBadge;
            if(a.level==='critical') lvlBadge='<span class="badge" style="background:rgba(248,81,73,.15);color:var(--red)">Critical</span>';
            else if(a.level==='warning') lvlBadge='<span class="badge" style="background:rgba(210,153,34,.15);color:var(--yellow)">Warning</span>';
            else lvlBadge='<span class="badge" style="background:rgba(88,166,255,.12);color:var(--blue)">Info</span>';
            const activeBadge = a.active ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>';
            return `<tr>
                <td style="max-width:400px">${a.content}</td>
                <td>${lvlBadge}</td>
                <td>${activeBadge}</td>
                <td style="font-size:12px;color:var(--text-muted)">${fmtTime(a.created_at)}</td>
                <td class="actions">
                    <button class="btn btn-sm" onclick="openEditAnn(${a.id},'${a.content.replace(/'/g,"\\'")}','${a.level}',${a.active})">Edit</button>
                    <button class="btn btn-sm" onclick="toggleAnn(${a.id},${a.active?0:1})">${a.active?'Hide':'Show'}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAnn(${a.id})">Delete</button>
                </td>
            </tr>`;
        }).join('');
    });
}

function openCreateAnn() {
    editingAnnId = null;
    document.getElementById('annModalTitle').textContent = 'New Announcement';
    document.getElementById('annModalBtn').textContent = 'Create';
    document.getElementById('annContent').value = '';
    document.getElementById('annLevel').value = 'info';
    document.getElementById('annModal').classList.add('active');
}

function openEditAnn(id, content, level, active) {
    editingAnnId = id;
    document.getElementById('annModalTitle').textContent = 'Edit Announcement';
    document.getElementById('annModalBtn').textContent = 'Save';
    document.getElementById('annContent').value = content;
    document.getElementById('annLevel').value = level;
    document.getElementById('annModal').classList.add('active');
}

function submitAnn() {
    const content = document.getElementById('annContent').value.trim();
    const level = document.getElementById('annLevel').value;
    if(!content) { alert('Content is required'); return; }
    if(editingAnnId) {
        api('/api/admin/announcements/'+editingAnnId, {
            method:'PUT', body:JSON.stringify({content, level})
        }).then(r => { if(r.error){alert(r.error);return;} closeModal('annModal'); loadAnnouncements(); });
    } else {
        api('/api/admin/announcements', {
            method:'POST', body:JSON.stringify({content, level})
        }).then(r => { if(r.error){alert(r.error);return;} closeModal('annModal'); loadAnnouncements(); });
    }
}

function toggleAnn(id, active) {
    api('/api/admin/announcements/'+id, {method:'PUT', body:JSON.stringify({active})})
        .then(() => loadAnnouncements());
}

function deleteAnn(id) {
    if(!confirm('Delete this announcement?')) return;
    api('/api/admin/announcements/'+id, {method:'DELETE'}).then(() => loadAnnouncements());
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
function loadAll() {
    api('/api/admin/servers').then(d => { allServers = d; });
    loadUsers();
    loadInvites();
    loadServers();
    loadAnnouncements();
    loadRegistrationSettings();
}
loadAll();
</script>
</body>
</html>
